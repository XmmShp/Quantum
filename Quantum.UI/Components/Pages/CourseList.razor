@page "/courses"
@using Quantum.Core.Models
@using Quantum.Core.Interfaces
@using Quantum.Core.Constants
@using Quantum.UI.Components.Shared
@inject ICourseScrapingService CourseScraper
<style>
    /* 页面容器 */
    .page-container {
        padding: 24px;
        background: white;
    }

    /* 搜索面板 */
    .search-panel {
        background: #fafafa;
        padding: 24px;
        border-radius: 8px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    /* 分类按钮 */
    .category-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 24px;
    }

    /* 自定义按钮样式 */
    .button-custom {
        border-radius: 6px !important;
        padding: 4px 16px !important;
        border: 1px solid #e8e8e8 !important;
        background-color: white !important;
        color: #595959 !important;
        transition: all 0.3s !important;
    }

    .button-custom:hover {
        color: #1890ff !important;
        border-color: #1890ff !important;
        background-color: #e6f7ff !important;
    }

    /* 加载状态 */
    .loading-container {
        padding: 48px 0;
        text-align: center;
    }

    .button-custom {
    border-radius: 8px !important;
    padding: 3px 24px !important;
    border: 2px solid #dcdcdc !important; /* 浅灰色边框 */
    background-color: white !important; /* 设置按钮背景颜色为白色 */
    color: #333 !important; /* 设置文本颜色，确保在白色背景上清晰可见 */
    }
    .category-section {
        margin-bottom: 16px;
    }
    .category-title {
        font-weight: bold;
        margin-bottom: 8px;
    }
    /* 添加悬浮侧边栏样式 */
    .floating-sidebar {
        position: fixed;
        top: 0;
        right: -400px; /* 初始状态在屏幕右侧外 */
        width: 400px;
        height: 100vh;
        background-color: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease-in-out;
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
    }

    .course-list-container {
        position: relative;
        min-height: 100vh;
    }

    .course-list-container:hover .floating-sidebar {
        right: 0; /* 鼠标悬浮时滑入 */
    }
</style>

<PageTitle>课程列表 - Quantum 选课助手</PageTitle>

<div class="page-container">
    @* 实现search功能 *@
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <Title Level="2" style="margin: 0;">课程列表</Title>
        <Space>
            <SpaceItem>
                <Button Type="@ButtonType.Primary" OnClick="@(() => { _wishListVisible = true; })">
                    <Icon Type="heart" Theme="IconThemeType.Outline" /> 愿望单
                </Button>
            </SpaceItem>
            <SpaceItem>
                <Button Type="@ButtonType.Link" OnClick="ToggleSearchPanel">
                    <Icon Type="@(_showSearchPanel ? "up" : "down")" Theme="IconThemeType.Outline" />
                    @(_showSearchPanel ? "收起筛选" : "展开筛选")
                </Button>
            </SpaceItem>
        </Space>
    </div>

    

    @if (_showSearchPanel)
    {
        <div class="search-panel">
            <Row Gutter="16">

                <AntDesign.Col Span="6">
                    <AntDesign.Input Placeholder="课程代码" @bind-Value="_searchFilters.CourseCode">
                        <Prefix>
                            <Icon Type="number" Theme="IconThemeType.Outline" />
                        </Prefix>
                    </AntDesign.Input>
                </AntDesign.Col>

                <AntDesign.Col Span="6">
                    <AntDesign.Input Placeholder="课程名称" @bind-Value="_searchFilters.CourseName">
                        <Prefix>
                            <Icon Type="book" Theme="IconThemeType.Outline" />
                        </Prefix>
                    </AntDesign.Input>
                </AntDesign.Col>

                <AntDesign.Col Span="6">
                    <AntDesign.Input Placeholder="课程类别" @bind-Value="_searchFilters.Category">
                        <Prefix>
                            <Icon Type="tag" Theme="IconThemeType.Outline" />
                        </Prefix>
                    </AntDesign.Input>
                </AntDesign.Col>
            </Row>
            <Row Gutter="16" Style="margin-top: 16px;">
                <AntDesign.Col Span="6">
                    <AntDesign.Input Placeholder="开课学院" @bind-Value="_searchFilters.Department">
                        <Prefix>
                            <Icon Type="bank" Theme="IconThemeType.Outline" />
                        </Prefix>
                    </AntDesign.Input>
                </AntDesign.Col>

                <AntDesign.Col Span="6">
                    <AntDesign.Input Placeholder="教师" @bind-Value="_searchFilters.Instructor">
                        <Prefix>
                            <Icon Type="user" Theme="IconThemeType.Outline" />
                        </Prefix>
                    </AntDesign.Input>
                </AntDesign.Col>

                <AntDesign.Col Span="12">
                    <Space>
                        <SpaceItem>
                            <Button Type="@ButtonType.Primary" OnClick="ApplySearch">
                                <Icon Type="search" Theme="IconThemeType.Outline" /> 搜索
                            </Button>
                        </SpaceItem>
                        <SpaceItem>
                            <Button OnClick="ClearSearch">
                                <Icon Type="clear" Theme="IconThemeType.Outline" /> 清空
                            </Button>
                        </SpaceItem>
                    </Space>
                </AntDesign.Col>
            </Row>
        </div>
    }

    <Divider />

    <div class="category-buttons">
        <Button @onclick="() => FetchCourse(CourseCategory.MyCategory)" Shape="ButtonShape.Round">本专业课程</Button>

        <AntDesign.Dropdown Placement="Placement.Bottom">
            <Overlay>
                <Menu>
                    @foreach (var category in CourseCategories.CompulsoryCourses)
                    {
                        <MenuItem>
                            <Button @onclick="() => FetchCourse(category.Id)" class="button-custom">@category.Name</Button>
                        </MenuItem>
                    }
                </Menu>
            </Overlay>
            <ChildContent>
                <Button Shape="ButtonShape.Round">通识必修课</Button>
            </ChildContent>
        </AntDesign.Dropdown>

        <AntDesign.Dropdown Placement="Placement.Bottom">
            <Overlay>
                <Menu>
                    @foreach (var category in CourseCategories.ElectiveCourses)
                    {
                        <MenuItem>
                            <Button @onclick="() => FetchCourse(category.Id)" class="button-custom">@category.Name</Button>
                        </MenuItem>
                    }
                </Menu>
            </Overlay>
            <ChildContent>
                <Button Shape="ButtonShape.Round">通识选修课</Button>
            </ChildContent>
        </AntDesign.Dropdown>

        <Button @onclick="() => FetchCourse(CourseCategory.PhysicalEdu)" Shape="ButtonShape.Round">体育课</Button>
        <Button @onclick="() => FetchCourse(CourseCategory.MajorFundation)" Shape="ButtonShape.Round">专业基础课程</Button>

        <AntDesign.Dropdown Placement="Placement.Bottom">
            <Overlay>
                <Menu>
                    @foreach (var category in CourseCategories.MajorCourses)
                    {
                        <MenuItem>
                            <Button @onclick="() => FetchCourse(category.Id)" class="button-custom">@category.Name</Button>
                        </MenuItem>
                    }
                </Menu>
            </Overlay>
            <ChildContent>
                <Button Shape="ButtonShape.Round">专业课程</Button>
            </ChildContent>
        </AntDesign.Dropdown>

        <AntDesign.Dropdown Placement="Placement.Bottom">
            <Overlay>
                <Menu>
                    @foreach (var category in CourseCategories.AccreditedCourses)
                    {
                        <MenuItem>
                            <Button @onclick="() => FetchCourse(category.Id)" class="button-custom">@category.Name</Button>
                        </MenuItem>
                    }
                </Menu>
            </Overlay>
            <ChildContent>
                <Button Shape="ButtonShape.Round">认定型课程</Button>
            </ChildContent>
        </AntDesign.Dropdown>

        @foreach (var category in CourseCategories.SpecialCourses)
        {
            <Button @onclick="() => FetchCourse(category.Id)" Shape="ButtonShape.Round">@category.Name</Button>
        }
    </div>

    <Spin Spinning="@_isLoadingCourses">
        <div>
            @if (_courses.Any())
            {
                <div>
                    <GridRow>
                        <GridCol Span="24">
                            <Collapse Accordion>
                                @foreach (var course in _filteredCourses)
                                {
                                    @* 在这里进行第二步请求 ：课程的具体section*@
                                    <Panel Key="@($"course-{course.CourseCode}")" HeaderTemplate="@GetHeader(course)" OnActiveChange="isActive => OnPanelActiveChange(course, isActive)">
                                        <Spin Spinning="@_isLoadingSections">
                                            <CourseSectionTable Sections="course.Sections" ShowActions="true"/>
                                        </Spin>
                                    </Panel> 
                                }
                            </Collapse>
                        </GridCol>
                    </GridRow>
                    @if (_hasMoreData || _currentPage > 1)
                    {
                        <GridRow Style="margin-top: 16px;">
                            <GridCol Span="24" Style="display: flex; justify-content: center;">
                                <Pagination 
                                    Total="@(_currentPage * PageSize + (_hasMoreData ? PageSize : 0))"
                                    PageSize="@PageSize"
                                    Current="_currentPage"
                                    OnChange="OnPageChange"
                                    HideOnSinglePage="true" 
                                    ShowSizeChanger="false"/>
                            </GridCol>
                        </GridRow>
                    }
                </div>
            }
        </div>
    </Spin>
</div>

@* 添加Modal组件 *@
<Modal Title="@($"课程介绍 - {_selectedCourse?.Name ?? ""}")"
       Visible="@_introductionVisible"
       OnCancel="@(() => _introductionVisible = false)"
       Width="1000"
       Footer="null">
    @if (_selectedCourse != null)
    {
        <CourseIntroduction Course="@_selectedCourse" />
    }
</Modal>

<Drawer Visible="@_wishListVisible"
        Closable="true"
        OnClose="@(() => _wishListVisible = false)"
        Width="800"
        Title=@("愿望单")>
    <WishListTable />
</Drawer>

@code {
    private bool _isLoadingSections;
    private bool _isLoadingCourses = true;
    private bool _showSearchPanel = false;
    private /* readonly */ List<Course> _courses = [];
    private List<Course> _filteredCourses = [];
    private SearchFilters _searchFilters = new();
    private bool _introductionVisible;
    private bool _wishListVisible;
    private Course? _selectedCourse;

    // 分页相关变量
    private const int PageSize = 20;
    private int _currentPage = 1;
    private bool _hasMoreData = true;
    private int Begin => (_currentPage - 1) * PageSize + 1;
    private int End => _currentPage * PageSize;

    private async Task FetchCourse(CourseCategory category)
    {
        _isLoadingCourses = true;
        _lastFetchType = category;
        StateHasChanged();

        try
        {
            var fetchedCourses = await CourseScraper.GetAvailableCoursesAsync(category, Begin, End);
            _courses = fetchedCourses;
            // 如果获取到的数据量小于请求的数量，说明已经到达末尾
            _hasMoreData = fetchedCourses.Count >= PageSize;
            _filteredCourses = _courses;
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error fetching courses: {ex.Message}");
            _hasMoreData = false;
        }
        finally
        {
            _isLoadingCourses = false;
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _courses.Clear();
            var fetchedCourses = await CourseScraper.GetAvailableCoursesAsync(CourseCategory.MyCategory, 1, PageSize);
            _courses.AddRange(fetchedCourses);
            // 如果获取到的数据量小于请求的数量，说明已经到达末尾
            _hasMoreData = fetchedCourses.Count >= PageSize;
            _filteredCourses = _courses;
        }
        finally
        {
            _isLoadingCourses = false;
            StateHasChanged();
        }
    }

    private async Task OnPageChange(PaginationEventArgs args)
    {
        if (args.Page != _currentPage && (args.Page < _currentPage || _hasMoreData))
        {
            _currentPage = args.Page;
            await FetchCourse(_lastFetchType);
        }
    }

    private CourseCategory _lastFetchType = CourseCategory.MyCategory;

    //处理search问题
    private class SearchFilters
    {
        public string CourseCode { get; set; } = string.Empty;
        public string CourseName { get; set; } = string.Empty;
        public string Category { get; set; } = string.Empty;
        public string Department { get; set; } = string.Empty;
        public string Instructor { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
    }

    private void ApplySearch()
    {
        _filteredCourses = _courses.Where(course =>
            (string.IsNullOrEmpty(_searchFilters.CourseCode) || course.CourseCode.Contains(_searchFilters.CourseCode)) &&
            (string.IsNullOrEmpty(_searchFilters.CourseName) || course.Name.Contains(_searchFilters.CourseName)) &&
            (string.IsNullOrEmpty(_searchFilters.Department) || course.Department.Contains(_searchFilters.Department)) &&
            (string.IsNullOrEmpty(_searchFilters.Instructor) || course.Sections.Any(s => s.InstructorName.Contains(_searchFilters.Instructor))) &&
            (string.IsNullOrEmpty(_searchFilters.Status) || course.Status.ToString() == _searchFilters.Status)
        ).ToList();
    }
    private void ClearSearch()
    {
        _searchFilters = new SearchFilters();
        _filteredCourses = _courses;
    }

    private void ToggleSearchPanel()
    {
        _showSearchPanel = !_showSearchPanel;
    }

    private async Task OnPanelActiveChange(Course course, bool isActive)
    {

        // 当面板展开时 (isActive 为 true)，我们可以更新 course.Sections

        if (isActive)
        {

            _isLoadingSections = true;
            try{
                // 模拟更新 course.Sections 数据
                course.Sections = await CourseScraper.GetSectionOfACourse(course,course.Category is CourseCategory.PhysicalEdu);
                foreach (var section in course.Sections)
                {
                    section.PlotFlags.ForEach(Console.WriteLine);
                }
            }

            finally{
                _isLoadingSections = false;
            }
            StateHasChanged();  // 强制组件更新，渲染新数据
        }

    }

    private RenderFragment<Course> GetHeader => course => __builder =>
    {
        <div>
            <GridRow>
                <GridCol Span="4">
                    <AntDesign.Text Strong>
                        @course.CourseCode
                    </AntDesign.Text>
                </GridCol>
                <GridCol Span="4">
                    @course.Name
                </GridCol>
                <GridCol Span="6">
                    <AntDesign.Tag Color=@("Cyan")>
                        @course.Department
                    </AntDesign.Tag>
                </GridCol>
                <GridCol Span="2">
                    @course.Credits
                </GridCol>
                <GridCol Span="4"/>
                <GridCol Span="2">
                    <Button Type="@ButtonType.Link" 
                            OnClick="() => ShowCourseIntroduction(course)"
                            OnClickStopPropagation="true"
                            Size="ButtonSize.Small">
                        <Icon Type="info-circle" Theme="IconThemeType.Outline" /> 课程介绍
                    </Button>
                </GridCol>
            </GridRow>
        </div>
    };

    private void ShowCourseIntroduction(Course course)
    {
        _selectedCourse = course;
        _introductionVisible = true;
    }
}